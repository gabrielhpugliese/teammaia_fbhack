{% extends 'base.html' %}

{% block extra_body %}

<div id='player1'>
	<img src='{{ me.get_profile.pic_big }}' />
	<h2 class='turn'></h2>
	<h2 class='cards'></h2>
	<img class='friend' src='' />
	<h3></h3>
	<a class="attr1"></a>
	<a class="attr2"></a>
	
</div>
<div id='player2'>
	<img src='{{ opponent.get_profile.pic_big }}' />
	<h2 class='turn'></h2>
	<h2 class='cards'></h2>
	<img class='friend' src='' />
	<h3></h3>
	<a class="attr1"></a>
	<a class="attr2"></a>
</div>
<a id='finish-button' href=''>Finish</a>
<script>
$(document).ready(function(){
	setTimeout('check_finish()', 1*1000);
	setTimeout('get_lock()', 1*1000);
	get_next_card();
	resolve_round();
});

$("#finish-button").click(function(event){
    event.preventDefault();
    console.log("clicado");
    $.post('/finish_game/',{ game_pk: {{ game_pk }} }, function(data) {
        console.log(data);
        self.location = '/canvas/';
    });
});

function check_finish(){
	setTimeout('check_finish()', 1*1000);
	$.get('/check_finish/{{ game_pk }}', function(data){
		if(data == 'OK'){
			self.location = '/canvas/';
		}
	})
}

function get_next_card(){
	var player = $('#player1');
	var data;
	hide_opponent_card();
	$.get('/get_next_card/', {game_pk: {{ game_pk }}}, function(resp){
		data = $.parseJSON(resp);
		console.log('VEIO DO GET_NEXT_CARD');
		console.log(data);
		player.find('.cards').html('Cards Remaining:'+data.my_deck_len);
		player.find('.friend').attr('src', data.pic_square);
		player.find('h3').html(data.name);
	}).success(function(){
		$.get('/get_turn/{{ game_pk }}', function(resp){
			player.find('#turn').html('');
			if(resp == 'OK'){
				player.find('.turn').html('Your turn');
				player.find('.attr1').attr('href', '');
				player.find('.attr1').html('Friends: '+data.attr1);
				player.find('.attr2').attr('href', '');
				player.find('.attr2').html('Likes: '+data.attr2);
			} else {
				player.find('.turn').html('Your opponent\'s turn');
				player.find('.attr1').html('Friends: '+data.attr1);
				player.find('.attr2').html('Likes: '+data.attr2);
			}
		});
	});
}

function show_opponent_card(card){
    var player = $('#player2');
    var opponent_deck_len = 40 - $('#player1 .cards').html().split(':')[1];
    player.find('.cards').html('Cards Remaining:'+opponent_deck_len);
	player.find('.friend').attr('src', card.pic_square);
	player.find('h3').html(card.name);
	player.find('.attr1').html('Friends: '+card.attr1);
	player.find('.attr2').html('Likes: '+card.attr2);
	setTimeout('get_next_card()', 3*1000);
}

function hide_opponent_card(){
	var player = $('#player2');
	var opponent_deck_len = 40 - $('#player1 .cards').html().split(':')[1];
    player.find('.cards').html('Cards Remaining:'+opponent_deck_len);
    player.find('.cards').html('');
	player.find('.friend').attr('src', '/static/img/question.png');
	player.find('h3').html('');
	player.find('.attr1').html('');
	player.find('.attr2').html('');
}

function resolve_round(){
	$('a').click(function(event){
		event.preventDefault();
		$.get('/resolve_round/', {attr: $(this).attr('class'), game_pk: {{ game_pk }} }, function(data){
			data = $.parseJSON(data);
			console.log('EH NOIZ');
			if(data.status == 'OK'){
				show_opponent_card(data.card);
			}
			else if (data.status == 'Ganhei'){
				alert('Você ganhou! :)');
				self.location = '/canvas/';
			}
				
		});
	});
}

function get_lock(){
	setTimeout('get_lock()', 1*1000);
	$.get('/get_lock', { game_pk: {{ game_pk }} }, function(data){
		data = $.parseJSON(data);
		if(data.status == 'OK'){
			console.log('VEIO DO GET_LOCK');
			show_opponent_card(data.card);
		} else if (data.status == 'Perdi') {
			alert('Você Perdeu :(');
			self.location = '/canvas/';
		}
	});
}
</script>
{% endblock %}
