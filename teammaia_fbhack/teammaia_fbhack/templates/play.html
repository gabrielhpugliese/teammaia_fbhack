{% extends 'base.html' %}

{% block title %} On game - {{ user.get_full_name }} versus  {% endblock %}

{% block extra_body %}
   <div class="navbar navbar-fixed-top facecards-navbar">
       <div class="navbar-inner">
           <div class="container">
                  <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> 
                      <span class="icon-bar"></span> 
                      <span class="icon-bar"></span> 
                      <span class="icon-bar"></span> 
                  </a> 
                  <a class="brand" href="{% url login %}">Facecards</a>
                   <div class="nav-collapse pull-right">
                   <ul class="nav">
                   <li class="dropdown">
                      <a href="#" class="dropdown-toggle" data-toggle="dropdown">{{ user.get_full_name }}<b class="caret"></b></a>
                      <ul class="dropdown-menu">
                      	   <li><a href=".">Editar perfil</a></li>
	                       <li><a href=".">Alterar senha</a></li>
	                       <li><a href=".">Alterar email</a></li>
	                       <li class="divider"></li>
	                       <li><a href=".">Sair</a></li>
                      </ul>
                   </li>
                </ul>
                </div>
           </div>
       </div>
   </div>
   <div id="begin" class="container"> 
   
      <div class="row">
         <div class="span5 offset1">
            <img alt="" src="{{ me.get_profile.pic_square }}">
            <h4>{{ me.get_full_name }}</h4>
            <h4 class='cards'></h4>
            <h4 class='turn'></h4>
            <br /><br /><br />
            <ul class="thumbnails">
            <li class="span3">
            </li>
            <li class="span2">
            <div class="thumbnail">
            
         	<div id='player1'>				
				<img src=''/>
				<h3></h3>
				<a class="attr1"></a><br />
				<a class="attr2"></a>
			</div>
			</div>
			</li>
			</ul>
         </div>
         <div class="span5">
         	<div id='player2'>
          	</div>
         </div>
      </div>
      <a id='finish-button' class="btn btn-small" href=''>Finish</a>
   </div>

<script>
$(document).ready(function(){
	setTimeout('check_finish()', 1*1000);
	setTimeout('get_lock()', 1*1000);
	get_next_card();
	resolve_round();
});

$("#finish-button").click(function(event){
    event.preventDefault();
    console.log("clicado");
    $.post('/finish_game/',{ game_pk: {{ game_pk }} }, function(data) {
        console.log(data);
        self.location = '/canvas/';
    });
});

function check_finish(){
	setTimeout('check_finish()', 1*1000);
	$.get('/check_finish/{{ game_pk }}', function(data){
		if(data == 'OK'){
			self.location = '/canvas/';
		}
	})
}

function get_next_card(){
	var player = $('#player1');
	var data;
	$.get('/get_next_card/', {game_pk: {{ game_pk }}}, function(resp){
		data = $.parseJSON(resp);
		console.log('VEIO DO GET_NEXT_CARD');
		console.log(data);
		player.find('.cards').html('Cards Remaining:'+data.my_deck_len);
		player.find('.friend').attr('src', data.pic_square);
		player.find('h3').html(data.name);
	}).success(function(){
		$.get('/get_turn/{{ game_pk }}', function(resp){
			player.find('#turn').html('');
			if(resp == 'OK'){
				player.find('.turn').html('Your turn');
				player.find('.attr1').attr('href', '');
				player.find('.attr1').html('Friends: '+data.attr1);
				player.find('.attr2').attr('href', '');
				player.find('.attr2').html('Likes: '+data.attr2);
			} else {
				player.find('.turn').html('Your opponent\'s turn');
				player.find('.attr1').html('Friends: '+data.attr1);
				player.find('.attr2').html('Likes: '+data.attr2);
			}
		});
	});
}

function resolve_round(){
	$('a').click(function(event){
		event.preventDefault();
		$.get('/resolve_round/', {attr: $(this).attr('class'), game_pk: {{ game_pk }} }, function(data){
			console.log('EH NOIZ');
			if(data == 'OK')
				get_next_card();
			else if (data == 'Ganhei'){
				alert('Você ganhou! :)');
				self.location = '/canvas/';
			}
				
		});
	});
}

function get_lock(){
	setTimeout('get_lock()', 1*1000);
	$.get('/get_lock', { game_pk: {{ game_pk }} }, function(data){
		if(data == 'OK'){
			console.log('VEIO DO GET_LOCK');
			get_next_card();
		} else if (data == 'Perdi') {
			alert('Você Perdeu :(');
			self.location = '/canvas/';
		}
	});
}
</script>
{% endblock %}
